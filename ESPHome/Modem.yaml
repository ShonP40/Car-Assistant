####################################################################################################
#####                                    Car Assistant                                         #####
#####                  Repository: https://github.com/ShonP40/Car-Assistant                    #####
####################################################################################################
##### Purpose: Modem and GPS config & sensors                                                  #####
####################################################################################################
##### NOTE:                                                                                    #####
##### - Make changes ONLY if absolutely necessary and you have the required knowledge.         #####
##### - For normal system use, modifications to this file are NOT required.                    #####
####################################################################################################

external_components:
  - source: github://pr#6721 # Docs: https://deploy-preview-4056--esphome.netlify.app/components/modem.html
    components: [ network, modem, watchdog ]
    refresh: 10min

http_request:

modem:
  id: atmodem
  rx_pin: ${modem_rx_pin}
  tx_pin: ${modem_tx_pin}
  baud_rate: 115200
  power_pin:
    number: ${modem_power_pin}
    inverted: ${modem_power_pin_inverted}
  status_pin: ${modem_status_pin}
  model: ${modem_model}
  apn: ${modem_apn}
  pin_code: ${modem_pin_code}
  enable_on_boot: true
  enable_cmux: true
  reboot_timeout: 5min
  init_at:
    - AT+CGMM  # model
  on_not_responding:
    - logger.log: "modem not responding"
  on_connect:
    - logger.log: "modem connected"
  on_disconnect:
    - logger.log: "modem disconnected"
  nmea:
    id: nmea_data

gps:
  uart_id: nmea_data
  latitude:
    name: "${friendly_name} Latitude"
  longitude:
    name: "${friendly_name} Longitude"
  altitude:
    name: "${friendly_name} Altitude"
  speed:
    name: "${friendly_name} Speed"
  course:
    name: "${friendly_name} Course"
  satellites:
    name: "${friendly_name} Satellites"
  hdop:
    name: "${friendly_name} Horizontal Dilution Of Precision"
    id: ${id}_hdop

interval:
  - interval: 5min
    then:
      - if:
          condition:
            - modem.connected:
          then:
            - http_request.send:
                method: get
                url: "http://api.ipify.org"
                capture_response: true
                on_response:
                  then:
                    - lambda: |-
                          id(${id}_public_ip).publish_state(body);

text_sensor:
  - platform: modem
    network_type:
      name: "${friendly_name} Network Type"
      entity_category: "diagnostic"
    signal_strength:
      name: "${friendly_name} Signal Strength"
      entity_category: "diagnostic"
  - platform: template
    name: "${friendly_name} Public IP"
    id: ${id}_public_ip
    entity_category: "diagnostic"

sensor:
  - platform: modem
    rssi:
      name: "${friendly_name} RSSI"
      entity_category: "diagnostic"
    ber:
      name: "${friendly_name} Bit Error Rate"
      entity_category: "diagnostic"
  - platform: template
    name: "${friendly_name} GPS Accuracy"
    unit_of_measurement: "m"
    accuracy_decimals: 1
    lambda: return id(${id}_hdop).state * 5.0;

switch:
  - platform: gpio
    id: flight_mode
    name: "${friendly_name} Flight Mode"
    restore_mode: ALWAYS_ON
    pin:
      number: ${modem_flight_mode_pin}
    internal: true
    entity_category: "diagnostic"
  - platform: modem
    gnss:
      name: "${friendly_name} GNSS"
      restore_mode: ALWAYS_ON